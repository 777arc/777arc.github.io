
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>15. Compleet voorbeeld &#8212; PySDR: A Guide to SDR and DSP using Python</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TGRQK1JJYD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TGRQK1JJYD');
</script>

<div style="float: right; padding-bottom: 0;">
  PySDR is now available in:&nbsp;&nbsp;
  <img src="https://pysdr.org/_static/us.svg" alt="English Version" width="20"><a href="https://pysdr.org/index.html">English</a>&nbsp;&nbsp;
  <img src="https://pysdr.org/_static/nl.svg" alt="Dutch Version" width="20"><a href="https://pysdr.org/nl/index-nl.html">Dutch</a>&nbsp;&nbsp;
  <img src="https://pysdr.org/_static/fr.svg" alt="French Version" width="20"><a href="https://pysdr.org/fr/index-fr.html">French</a>
</div>

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../index-fr.html">
    <img class="logo" src="../_static/logo.svg" alt="Logo"/>
    
    <h1 class="logo logo-name">PySDR: A Guide to SDR and DSP using Python</h1>
    
  </a>
</p>



<p class="blurb">By <a href="https://pysdr.org/content/about_author.html">Dr. Marc Lichtman</a></p>






<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/frequency_domain.html">2. Domaine fréquentiel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/sampling.html">3. échantillonnage IQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/digital_modulation.html">4. Modulation numérique</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/pluto.html">5. PlutoSDR en Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/usrp.html">6. USRP en Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/noise.html">7. le Bruit et les dB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/filters.html">8. Filtres</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/link_budgets.html">9. Bilans de liaison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/channel_coding.html">10. Codage Canal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/iq_files.html">11. Fichiers IQ et SigMF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/multipath_fading.html">12. Evanouissement par Multi-Trajets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/pulse_shaping.html">13. Mise en Forme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/sync.html">14. Synchronisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/rds.html">15. Exemple bout en bout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../content-fr/about_author.html">16. A propos de l’auteur</a></li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="https://trinket.io/embed/python3">Online Python Console</a></li>
    
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index-fr.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
              <div class="related top">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          

          <div class="body" role="main">
            
  <div class="section" id="compleet-voorbeeld">
<span id="rds-chapter"></span><h1><span class="section-number">15. </span>Compleet voorbeeld<a class="headerlink" href="#compleet-voorbeeld" title="Permalink to this headline">¶</a></h1>
<p>We zullen in dit hoofdstuk vele geleerde concepten samenbrengen en door een compleet voorbeeld heenlopen waarin we een echt digitaal signaal ontvangen en decoderen. We zullen kijken naar het Radio Data Systeem (RDS) wat een protocol is om kleine hoeveelheden informatie in een FM-signaal te stoppen, zoals de naam van het nummer. We zullen FM moeten demoduleren, verschuiven, filteren, decimeren, hersamplen, synchroniseren, decoderen en de bytes interpreteren. Er is sowieso een IQ-bestand beschikbaar waarmee je kunt testen wanneer je geen SDR klaar hebt liggen.</p>
<div class="section" id="introductie-fm-radio-en-rds">
<h2>Introductie FM-Radio en RDS<a class="headerlink" href="#introductie-fm-radio-en-rds" title="Permalink to this headline">¶</a></h2>
<p>Om RDS te kunnen begrijpen zullen we eerst kijken naar hoe een FM-signaal is opgebouwd.
Je bent waarschijnlijk al bekend met het audio gedeelte van een FM-signaal.
Naast de audio worden, in een FM-signaal, nog meer informatiecomponenten frequentie gemoduleerd.
In plaats van de signaalstructuur te Googelen kunnen we ook naar de PSD (spectrale vermogensdichtheid) kijken van een FM-signaal <em>na</em> demodulatie.
We bekijken enkel het positieve deel omdat een gedemoduleerd FM-signaal reëel is, zelfs als de ingang complex was.</p>
<div class="figure align-center" id="id3">
<span id="psd"></span><a class="reference external image-reference" href="../_images/fm_psd.svg" rel="noopener noreferrer" target="_blank"><img alt="../_images/fm_psd.svg" src="../_images/fm_psd.svg" /></a>
<p class="caption"><span class="caption-text">PSD van gedemoduleerd FM-signaal</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</div>
<p>Door het signaal in het frequentiedomein te bekijken zien we de volgende signalen:</p>
<ol class="arabic simple">
<li>Een signaal met een hoog vermogen tussen 0 - 17 kHz</li>
<li>Een toon op 19 kHz</li>
<li>Gecentreerd op 38 kHz en ongeveer 30 kHz breed zien we een interessant symmetrisch signaal.</li>
<li>Een dubbel signaal gecentreerd op 57 kHz</li>
<li>Een enkel signaal gecentreerd op 67 kHz</li>
</ol>
<p>Dit is alles wat we uit de PSD kunnen halen, en let op dat dit <em>na</em> de FM demodulatie is. De PSD voordat we het demoduleren ziet er als volgt uit, en dit verteld ons vrijwel niets.</p>
<a class="reference external image-reference" href="../_images/fm_before_demod.svg" rel="noopener noreferrer" target="_blank"><img alt="../_images/fm_before_demod.svg" class="align-center" src="../_images/fm_before_demod.svg" /></a>
<p>Toch is het belangrijk te beseffen dat wanneer je een signaal frequentiemoduleert, een hogere frequentie in de data ook een hogere frequentie in het FM-signaal zal opleveren.
Dus het signaal op 67 kHz zorgt ervoor dat de totale bandbreedte van het signaal toeneemt, de hoogste frequentiecomponent is ongeveer 75 kHz volgens figuur <code class="xref std std-numref docutils literal notranslate"><span class="pre">PSD</span></code>.
Wanneer we <a class="reference external" href="https://en.wikipedia.org/wiki/Carson_bandwidth_rule" rel="noopener noreferrer" target="_blank">de bandbreedte-regel van Carson</a> op FM toepassen, zegt dit dat een FM-zender ongeveer 250 kHz aan spectrum inneemt. Om deze reden samplen we meestal op 250 kHz (vergeet niet dat bij kwadratuur/IQ-sampling de ontvangen bandbreedte gelijk is aan de samplerate).</p>
<p>Sommige lezers die gewent zijn om de FM-band met een SDR of spectrumanalyzer te bekijken herkennen het volgende diagram. Misschien denk je dat de blokkige signalen naast de FM-zenders RDS zijn.</p>
<a class="reference internal image-reference" href="../_images/fm_band_psd.png"><img alt="../_images/fm_band_psd.png" class="align-center" src="../_images/fm_band_psd.png" style="width: 696.8000000000001px; height: 201.60000000000002px;" /></a>
<p>Het blijkt dat deze blokkige signalen eigenlijk HD Radio zijn, een digitale versie van hetzelfde FM-radiosignaal (zelfde audio).
Deze digitale versie geeft de ontvanger een hogere kwaliteit audio, omdat digitale signalen geen analoge ruis bevatten zoals het analoge signaal.</p>
<p>Weer terug naar de 5 signalen die we in onze PSD herkenden; Het volgende diagram laat zien waar elk signaal voor wordt gebruikt:</p>
<a class="reference internal image-reference" href="../_images/fm_components.png"><img alt="../_images/fm_components.png" class="align-center" src="../_images/fm_components.png" style="width: 625.6px; height: 380.8px;" /></a>
<p>We doorlopen deze signalen in willekeurige volgorde:</p>
<p>De mono en stereo audiosignalen bevatten gewoon de audio. Je kunt doormiddel van optellen of aftrekken de linker en rechter kanalen onderscheiden.</p>
<p>De toon op 19 kHz wordt gebruikt om het stereo signaal te kunnen demoduleren. Door het verdubbelen van de toon kun je het gebruiken als frequentie- en fasereferentie, het audiosignaal is immers gecentreerd op 38 kHz. Dit verdubbelen kun je doen door de samples te kwadrateren.</p>
<p>DirectBand werd in Noord-Amerika gebruikt als een datanetwerk van Microsoft. Ook bekend als “MSN direct” onder de consumenten.
Het verstuurde informatie naar apparaten zoals GPS ontvangers, horloges en weerstations. Je kon zelfs berichtjes ontvangen van Windows Live Messenger. De meest succesvolle toepassing was real-time verkeersinformatie voor Garmin GPS-ontvangers. Dit werd door miljoenen mensen gebruikt voordat smartphones breed beschikbaar waren. De service is in januari 2012 uitgeschakeld. Naar mijn weten is dit nooit in Nederland toegepast.</p>
<p>Als laatste komen we bij RDS waar de rest van het hoofdstuk om draait. Zoals in de PSD is te zien, is het ongeveer 4 kHz breed en is het rechts van het stereosignaal te vinden. Het is een digitaal communicatieprotocol waarmee FM-stations op lage snelheid informatie kunnen oversturen zoals de naam van het station, programma informatie, tijd en overige dingen. De standaard is gepubliceerd als IEC 62106 en kun je <a class="reference external" href="http://www.interactive-radio-system.com/docs/EN50067_RDS_Standard.pdf" rel="noopener noreferrer" target="_blank">hier terugvinden</a>.</p>
</div>
<div class="section" id="het-rds-signaal">
<h2>Het RDS-Signaal<a class="headerlink" href="#het-rds-signaal" title="Permalink to this headline">¶</a></h2>
<p>We zullen in dit hoofdstuk Python toepassen om RDS te ontvangen. Om goed te begrijpen hoe je het ontvangt is het verstandig om eerst uit te zoeken hoe het signaal wordt gevormd en uitgezonden.</p>
<div class="section" id="zender">
<h3>Zender<a class="headerlink" href="#zender" title="Permalink to this headline">¶</a></h3>
<p>De RDS-informatie dat door een FM-station wordt verzonden (bijv. naam nummer) is gecodeerd in groepen van 8 bytes.
Elke set van 8 bytes, wat overeenkomt met 64 bits, wordt met 40 “controllebits” gegroepeerd. Deze 104 bits worden samen verzonden zonder enige vertraging tussen de groepen. De ontvanger moet dus de grens tussen de groepen zien te vinden. We gaan de details hierover bekijken wanneer we naar de ontvanger gaan.</p>
<p>Om deze bits draadloos te versturen gebruikt RDS BPSK. We hebben in het <a class="reference internal" href="digital_modulation.html#modulation-chapter"><span class="std std-ref">Digitale Modulatie</span></a> hoofdstuk gezien dat dit een simpel modulatieschema is waarmee de fase van de draaggolf is gekoppeld aan de enen en nullen.
RDS maakt gebruik van differentiële codering zodat we niet langer zorgen hoeven te maken over een 180 graden fasedraaiing.
De BPSK-symbolen worden verstuurd op een snelheid van 1187.5 symbolen per seconde.
Omdat BPSK slechts 1 bit per symbool gebruikt komt dit neer op een transmissiesnelheid van ongeveer 1.2 kbps.
RDS gebruikt geen kanaalcodering (foutcorrectie) maar bevat wel een CRC-som om fouten te kunnen detecteren.
De ervaren BPSK-er vraagt zich misschien af waarom het signaal twee zijbanden heeft in figuur <code class="xref std std-numref docutils literal notranslate"><span class="pre">PSD</span></code>; meestal heeft BPSK maar 1 zijband.
RDS blijkt het BPSK-signaal te dupliceren/spiegelen rondom 57 kHz voor extra redundantie.
Wanneer we de Python code gaan bekijken gebruiken we een filter om slechts een van deze BPSK-signalen te demoduleren.</p>
<p>Het dubbele BPSK-signaal wordt uiteindelijk verschoven in frequentie naar 57 kHz en aan alle andere componenten van het FM-signaal toegevoegd, voordat de frequentiemodulatie zelf plaatsvindt.
FM-signalen worden, vergeleken met andere draadloze communicatie, uitgezonden op extreem hoge vermogens, tot 80 kW!
Om deze reden hebben veel SDR-gebruikers een band-stop-filter met de antenne in serie gezet om te voorkomen dat het FM-signaal andere signalen overstemt.</p>
</div>
<div class="section" id="ontvanger">
<h3>Ontvanger<a class="headerlink" href="#ontvanger" title="Permalink to this headline">¶</a></h3>
<p>De volgende stappen zijn nodig om RDS te demoduleren en decoderen. Je hoeft deze lijst niet te onthouden, we zullen elke stap gaan behandelen:</p>
<ol class="arabic simple">
<li>FM-signaal ontvangen (of lees een IQ-opname), meestal met een samplerate van 250 kHz</li>
<li>“kwadratuur demodulatie” toepassen om het FM-signaal te demoduleren</li>
<li>Frequentieverschuiving van 57 kHz toepassen zodat het RDS-signaal zich rond de 0 Hz bevindt.</li>
<li>Laagdoorlaatfilter toepassen om alleen RDS over te houden</li>
<li>Decimeren met 10, na het filteren werken we toch met lagere frequenties</li>
<li>Hersamplen naar 19 kHz zodat we een geheel getal aan samples per symbool hebben</li>
<li>Een van de RDS-signalen wegfilteren met een banddoorlaatfilter</li>
<li>Tijdsynchronisatie, met behulp van Mueller en Muller in dit voorbeeld</li>
<li>Fijne frequentiesynchronisatie m.b.v. een Costas-loop</li>
<li>BPSK demoduleren naar 1’en en 0’en.</li>
<li>Differentieel decoderen</li>
<li>De 1’en en 0’en groeperen in bytes</li>
<li>De bytes ontleden tot de uiteindelijke data</li>
</ol>
<p>Het lijkt op een hoop stappen, maar RDS is een van de makkelijkste protocollen om te decoderen. Een modern protocol zoals wifi of 5G heeft een boek nodig om de PHY/MAC lagen uit te leggen.</p>
<p>We zullen nu gaan kijken naar de Python code waarmee we RDS kunnen ontvangen.
Deze code werkt met een <a class="reference external" href="https://github.com/versd/pysdr/blob/dutch/fm_1027mhz_250ksps?raw=true" rel="noopener noreferrer" target="_blank">FM opname die je hier kunt vinden</a>, of met een eigen ontvangen signaal zolang de SNR maar hoog genoeg is. Je hoeft alleen af te stemmen op de middenfrequentie van het FM-station en te samplen op 250 kHz.
Om het signaalvermogen te maximaliseren helpt het om een dipoolantenne toe te passen met de juiste lengte (~1.5 meter), niet de 2.4 GHz antennes van de Pluto.
Daarentegen is FM wel een heel luid signaal, als je dicht bij een raam staat, of buiten, is de 2.4 GHz antenne waarschijnlijk genoeg om sterke FM stations te ontvangen.</p>
<p>In de volgende delen behandelen we telkens een klein stukje code, maar de totale code is ook aan het einde van dit hoofdstuk te vinden.
Elk deel zal een stuk code geven en uitleggen wat het doet.</p>
</div>
</div>
<div class="section" id="signaal-ontvangen">
<h2>Signaal ontvangen<a class="headerlink" href="#signaal-ontvangen" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">resample_poly</span><span class="p">,</span> <span class="n">firwin</span><span class="p">,</span> <span class="n">bilinear</span><span class="p">,</span> <span class="n">lfilter</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Read in signal</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="s1">&#39;/home/versd/Downloads/fm_1027mhz_250ksps&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">complex64</span><span class="p">)</span>
<span class="n">sample_rate</span> <span class="o">=</span> <span class="mf">250e3</span>
<span class="n">center_freq</span> <span class="o">=</span> <span class="mf">102.7e6</span>
</pre></div>
</div>
<p>Hiermee lezen we de testopname in. De opname was gesampled op 250 kHz met een hoge SNR om RDS te kunnen decoderen. Je zult het pad naar het bestand moeten aanpassen voor jouw systeem. Je kunt natuurlijk ook een SDR gebruiken, alhoewel het zal helpen de code eerst te testen met de <a class="reference external" href="https://github.com/versd/pysdr/blob/dutch/fm_1027mhz_250ksps?raw=true" rel="noopener noreferrer" target="_blank">FM opname die je hier kunt vinden</a>.
Door alle code heen zullen we <code class="code docutils literal notranslate"><span class="pre">x</span></code> gebruiken als het signaal.</p>
</div>
<div class="section" id="fm-demodulatie">
<h2>FM Demodulatie<a class="headerlink" href="#fm-demodulatie" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Kwadratuur Demod</span>
<span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span> <span class="c1"># zie https://wiki.gnuradio.org/index.php/Quadrature_Demod</span>
</pre></div>
</div>
<p>Zoals aan het begin van het hoofdstuk is behandeld, wordt een FM-signaal gevormd door meerdere componenten te combineren en vervolgens te frequentiemoduleren om het door de lucht te zenden. De eerste stap is dus om die frequentiemodulatie ongedaan te maken.
Een andere manier om erover na te denken is dat de informatie in de frequentievariatie van het ontvangen signaal is gestopt, en we de informatie willen demoduleren zodat het in de amplitudeverschillen gaat zitten, en niet langer frequentie.
Let op dat de uitgang een reëel signaal is, terwijl de ingang complex was.</p>
<p>Wat deze enkele regel Python-code doet is de vermenigvuldiging uitrekenen tussen ons signaal en een vertraagde en geconjugeerde versie van ons signaal. Hierna berekent het de fase van elke sample van het resultaat, dit is het moment waar het signaal reëel wordt.
We kunnen als volgt bewijzen dat deze regel inderdaad de informatie uit de frequentievariatie onttrekt.
Neem een toon met frequentie <img class="math" src="../_images/math/6fae9f9f4e88f9ed9c4f703e00e569d4c953562b.svg" alt="f"/> en fase <img class="math" src="../_images/math/f41d2a61cd1827c3e57537176609abab588ccc27.svg" alt="\phi"/> dat we kunnen uitdrukken als <img class="math" src="../_images/math/aeac5aa1d2208522259f5d0cd24b363631ecce9a.svg" alt="e^{j2 \pi (f t + \phi)}"/>.
Als we nu in de discrete tijd gaan denken, gebruiken we niet langer de continue t maar maken we stappen van nT met T de duur van de stap.
Voor het gemak maken we T gelijk aan 1 en kunnen dan de vergelijking schrijven als <img class="math" src="../_images/math/607c18b46862d6504e95efda4552d5a4a9346485.svg" alt="e^{j2 \pi (f n + \phi)}"/>.
Het geconjugeerde en vertraagde signaal is dan <img class="math" src="../_images/math/ed969a9f9a6f32e3a84981843e060acfd3d09bea.svg" alt="e^{-j2 \pi (f (n-1) + \phi)}"/>.
De regel wordt:</p>
<div class="math">
<p><img src="../_images/math/74a15499e70526a5c3f5bbe8abe8ade77f48a4e1.svg" alt="e^{j2 \pi (fn + \phi)}*e^{-j2 \pi (f(n-1) + \phi)}=e^{j2 \pi (fn-f(n-1) +\phi -\phi)} = e^{j2 \pi f}"/></p>
</div><p>Dit is mooi, want nu is <img class="math" src="../_images/math/f41d2a61cd1827c3e57537176609abab588ccc27.svg" alt="\phi"/> verdwenen en de hoek van het complexe getal is gelijk aan de huidige frequentie <img class="math" src="../_images/math/6fae9f9f4e88f9ed9c4f703e00e569d4c953562b.svg" alt="f"/>.</p>
<p>Een bijkomend voordeel van frequentiemodulatie is dat variaties in de amplitude van het ontvangen signaal geen impact heeft op het volume van de audio, zoals bij AM radio wel het geval is.</p>
</div>
<div class="section" id="frequentieverschuiving">
<h2>Frequentieverschuiving<a class="headerlink" href="#frequentieverschuiving" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Freq verschuiven</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">f_o</span> <span class="o">=</span> <span class="o">-</span><span class="mf">57e3</span> <span class="c1"># hoeveelheid in Hz</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span> <span class="c1"># tijdvector</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f_o</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="c1"># verschuiving</span>
</pre></div>
</div>
<p>We gaan nu het signaal in frequentie naar beneden schuiven met 57 kHz. We kunnen hiervoor de <img class="math" src="../_images/math/75b1957b6af6705b15dad8edeed42a40232645cb.svg" alt="e^{j2 \pi f_ot}"/> <em>truc</em> gebruiken uit het <a class="reference internal" href="sync.html#sync-chapter"><span class="std std-ref">Synchronisatie</span></a> hoofdstuk waarbij <code class="code docutils literal notranslate"><span class="pre">f_o</span></code> de verschuiving is in Hz en <code class="code docutils literal notranslate"><span class="pre">t</span></code> de tijdvector. Dat de tijdvector bij 0 begint is niet belangrijk, wat wel belangrijk is, is dat de juiste periodetijd wordt gebruikt, de inverse van de samplefrequentie.
Trouwens, omdat een reëel signaal gespiegeld is rond 0 Hz maakt het niet uit of we -57 of + 57 kHz verschuiven. Aan beide kanten van 0 Hz is het RDS-signaal te vinden.</p>
</div>
<div class="section" id="rds-eruit-filteren">
<h2>RDS eruit filteren<a class="headerlink" href="#rds-eruit-filteren" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># laagdoorlaatfilter</span>
<span class="n">taps</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">7.5e3</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">taps</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Nu zullen we alle signalen behalve RDS moeten wegfilteren. Omdat het RDS-signaal nu gecentreerd is rond 0 Hz willen we een laagdoorlaatfilter toepassen. We kunnen <code class="code docutils literal notranslate"><span class="pre">firwin()</span></code> gebruiken om de coëfficiënten van een FIR filter te berekenen. Het heeft alleen het aantal coëfficiënten en de kantelfrequentie nodig. De samplerate moet ook worden gegeven omdat de kantelfrequentie anders geen betekenis heeft voor firwin. Het resultaat is een symmetrisch laagdoorlaatfilter met reële coëfficiënten waarmee we het signaal kunnen convolueren.
We kiezen <code class="code docutils literal notranslate"><span class="pre">'valid'</span></code> om randeffecten te voorkomen bij de convolutie, alhoewel het in dit geval niet echt uitmaakt omdat we toch een enorm lang signaal geven waardoor een paar gekke samples aan de randen weinig invloed heeft.</p>
</div>
<div class="section" id="met-10-decimeren">
<h2>Met 10 decimeren<a class="headerlink" href="#met-10-decimeren" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Geen vouwvervorming meer dankzij het filter, nu decimeren met 10</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="mi">10</span><span class="p">]</span>
<span class="n">sample_rate</span> <span class="o">=</span> <span class="mf">25e3</span>
</pre></div>
</div>
<p>Telkens wanneer je een klein stuk van de originele bandbreedte overhoudt dankzij een filter (bijv. van 125 kHz <em>reële</em> bandbreedte naar 7.5 kHz), heeft het nut te decimeren. In het begin van het <a class="reference internal" href="sampling.html#sampling-chapter"><span class="std std-ref">IQ-sampling</span></a> hoofdstuk hebben we geleerd over de Nyquistfrequentie, en dat we een signaal met beperkte bandbreedte volledig kunnen opslaan, zolang we twee keer zo snel samplen als de hoogste frequentie in het signaal.
Dus, nu we ons laagdoorlaatfilter hebben toegepast is de hoogste frequentie ongeveer 7.5 kHz, en een samplerate van 15 kHz zou voldoende moeten zijn. Voor de zekerheid voegen we er nog een marge aan toe en gaan we een samplerate van 25 kHz gebruiken. Deze frequentie helpt later ook nog eens.</p>
<p>Om te decimeren kunnen we simpelweg 9 van de 10 samples weggooien. We hadden immers een frequentie van 250 kHz en we willen naar 25 kHz.
Dit lijkt in eerste instantie verwarrend, want 90% van de samples weggooien voelt alsof we informatie verliezen, maar als je het <a class="reference internal" href="sampling.html#sampling-chapter"><span class="std std-ref">IQ-sampling</span></a> hoofdstuk doorleest zie dat we echt niets verliezen vanwege het filter. Het laagdoorlaatfilter werkt als een anti-aliasing filter en vermindert de maximale frequentie en dus bandbreedte van het signaal.</p>
<p>Vanuit de code bekeken is dit de makkelijkste stap, maar vergeet niet de <code class="code docutils literal notranslate"><span class="pre">sample_rate</span></code> variabele nu ook aan te passen!</p>
</div>
<div class="section" id="hersamplen-naar-19-khz">
<h2>Hersamplen naar 19 kHz<a class="headerlink" href="#hersamplen-naar-19-khz" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Hersamplen naar 19kHz</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">resample_poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="c1"># omhoog, beneden</span>
<span class="n">sample_rate</span> <span class="o">=</span> <span class="mf">19e3</span>
</pre></div>
</div>
<p>In het <a class="reference internal" href="pulse_shaping.html#pulse-shaping-chapter"><span class="std std-ref">Pulse Shaping</span></a> hoofdstuk is het concept van “samples per symbool” duidelijk gemaakt en hebben we gezien dat een volledig aantal samples per symbool handiger is dan een fractioneel aantal.
Eerder is opgemerkt dat RDS met BPSK 1187.5 symbolen per seconde verstuurt.
Met een samplefrequentie van 25 kHz komt dit neer op 21.052631579 samples per symbool (denk hier even over na als je deze uitkomst niet volgt).
Wat we dus echt willen is een samplefrequentie dat een veelvoud is van 1187.5 Hz, maar wel voldoet aan Nyquist. In de vorige sectie hadden we besloten dat de samplefrequentie tenminste 15 kHz moest zijn en met een marge 25 kHz.</p>
<p>De gewenste samplefrequentie is nu afhankelijk van hoeveel samples per symbool we willen overhouden. Stel we willen 10 samples per symbool. De RDS-symboolfrequentie van 1187.5 maal 10 geeft ons een samplefrequentie van 11.875 kHz. Dit voldoet helaas niet aan Nyquist. Wat als we 13 samples per symbool proberen? Dan komen we uit op 15437.5 Hz. dit is wel boven de 15 kHz maar niet zo’n mooie frequentie. En wat als we de volgende macht van 2 proberen, dus 16 samples per symbool? 1187.5 maal 16 levert exact 19 kHz op! Dit nummer is geen toeval maar een protocol ontwerpkeuze.</p>
<p>Om de samplefrequentie nu van 25 kHz naar 19 kHz te brengen kunnen we <code class="code docutils literal notranslate"><span class="pre">resample_poly()</span></code> toepassen. Deze functie interpoleert met een gehele waarde, filtert, en decimeert met een gehele waarde. Dit is handig want nu kunnen we 25 en 19 gebruiken i.p.v. 25000 en 19000. Hadden we toch voor 13 samples per symbool gekozen, dan hadden we <code class="code docutils literal notranslate"><span class="pre">resample_poly()</span></code> niet kunnen gebruiken en zou alles veel lastiger worden.</p>
<p>Nogmaals, vergeet niet om de <code class="code docutils literal notranslate"><span class="pre">sample_rate</span></code> variabele aan te passen wanneer het is verandert.</p>
</div>
<div class="section" id="banddoorlaatfilter">
<h2>Banddoorlaatfilter<a class="headerlink" href="#banddoorlaatfilter" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Banddoorlaatfilter om 1 RDS BPSK signaal te isoleren</span>
<span class="n">taps</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="o">=</span><span class="mi">501</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05e3</span><span class="p">,</span> <span class="mf">2e3</span><span class="p">],</span> <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">pass_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">taps</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We weten dat RDS twee identieke BPSK signalen bevat gezien de vorm van de PSD (figuur <code class="xref std std-numref docutils literal notranslate"><span class="pre">PSD</span></code>).  We moeten er een kiezen, dus we kiezen willekeurig ervoor om het positieve deel te behouden door middel van een banddoorlaatfilter. Weer gebruiken we <code class="code docutils literal notranslate"><span class="pre">firwin()</span></code>, maar nu met  <code class="code docutils literal notranslate"><span class="pre">pass_zero=False</span></code> waarmee we aangeven dat het om een banddoorlaatfilter gaat. Er zijn dus twee kantelfrequenties nodig. Omdat we 0 Hz niet als kantelfrequentie kunnen opgeven, kiezen we voor 50 Hz. Als laatste verhogen we ook het aantal coëfficiënten zodat we een scherp filter krijgen. We kunnen deze instelling verifiëren door het filter in het tijd- en frequentiedomein te bekijken, d.m.v. de coëfficiënten en de FFT ervan. Zie dat de doorlaatband in het frequentiedomein tot bijna 0 Hz gaat.</p>
<a class="reference external image-reference" href="../_images/bandpass_filter_taps.svg" rel="noopener noreferrer" target="_blank"><img alt="../_images/bandpass_filter_taps.svg" class="align-center" src="../_images/bandpass_filter_taps.svg" /></a>
<a class="reference external image-reference" href="../_images/bandpass_filter_freq.svg" rel="noopener noreferrer" target="_blank"><img alt="../_images/bandpass_filter_freq.svg" class="align-center" src="../_images/bandpass_filter_freq.svg" /></a>
<p>Kanttekening: Op een gegeven moment zal ik dit filter vervangen met een echt matched filter (volgens mij gebruikt RDS een RRC filter). Met de firwin() aanpak kreeg ik dezelfde bitfout-frequentie als met GNU Radio’s gematchte filter, dus het is duidelijk geen harde eis.</p>
</div>
<div class="section" id="tijdsynchronisatie-symbool-niveau">
<h2>Tijdsynchronisatie (Symbool-niveau)<a class="headerlink" href="#tijdsynchronisatie-symbool-niveau" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Symbol sync, zoals uit het synchronisatie hoofdstuk sync chapter</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">x</span> <span class="c1"># zodat we met het synchronisatie hoofdstuk overeenkomen</span>
<span class="n">samples_interpolated</span> <span class="o">=</span> <span class="n">resample_poly</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># we interpoleren met 32, dit lijkt beter te werken dan 16</span>
<span class="n">sps</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># eerste inschatting van faseafwijking</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
<span class="n">out_rail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span> <span class="c1"># oude waardes opslaan</span>
<span class="n">i_in</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># input samples index</span>
<span class="n">i_out</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># output index (eerste twee zijn 0)</span>
<span class="k">while</span> <span class="n">i_out</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i_in</span><span class="o">+</span><span class="mi">32</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
    <span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples_interpolated</span><span class="p">[</span><span class="n">i_in</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="mi">32</span><span class="p">)]</span> <span class="c1">#neem het `beste` sample</span>
    <span class="n">out_rail</span><span class="p">[</span><span class="n">i_out</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_rail</span><span class="p">[</span><span class="n">i_out</span><span class="p">]</span> <span class="o">-</span> <span class="n">out_rail</span><span class="p">[</span><span class="n">i_out</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="p">]</span> <span class="o">-</span> <span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">out_rail</span><span class="p">[</span><span class="n">i_out</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">mm_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">+=</span> <span class="n">sps</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">mm_val</span>
    <span class="n">i_in</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span> <span class="c1"># afronden naar geheel getal</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="c1"># fractie berekenen</span>
    <span class="n">i_out</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># output index verhogen</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">i_out</span><span class="p">]</span> <span class="c1"># pak alleen de nuttige data</span>
</pre></div>
</div>
<p>Eindelijk kunnen we de symbool/tijdsynchronisatie gaan toepassen. We gebruiken exact dezelfde Mueller en Muller kloksynchronisatie code als uit het <a class="reference internal" href="sync.html#sync-chapter"><span class="std std-ref">Synchronisatie</span></a> hoofdstuk. Je kunt dat lezen mocht je meer willen weten over deze code. We stellen het aantal samples per symbool (<code class="code docutils literal notranslate"><span class="pre">sps</span></code>) in op 16, zoals eerder besloten. Een mu versterking van 0.8 is met trial-en-error gevonden als een waarde die goed werkt met ons signaal. De uitgang krijgt 1 sample per symbool met “zachte” samples en een mogelijke frequentieafwijking. De volgende animatie kunnen we gebruiken om te verifiëren dat we BPSK-symbolen krijgen (met een frequentieverschuiving wat rotatie veroorzaakt):</p>
<a class="reference internal image-reference" href="../_images/constellation-animated.gif"><img alt="../_images/constellation-animated.gif" class="align-center" src="../_images/constellation-animated.gif" style="width: 409.6px; height: 307.20000000000005px;" /></a>
<p>Mocht je een eigen FM-signaal gebruiken, en je krijgt nu niet twee aparte clusters van complexe samples, dan kan het synchronisatiealgoritme van hierboven niet synchroniseren of je hebt in de eerdere stappen een fout gemaakt. Je hoeft de constellatie niet te animeren, maar probeer niet alle samples te weergeven want dan zie je alleen een cirkel. Als je 100 of 200 samples per keer laat zien dan heb je een beter gevoel of dat er twee clusters zijn of niet, zelfs als ze ronddraaien.</p>
</div>
<div class="section" id="fijne-frequentiesynchronisatie">
<h2>Fijne Frequentiesynchronisatie<a class="headerlink" href="#fijne-frequentiesynchronisatie" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fijne freq sync</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">x</span> <span class="c1"># om met het sync hoofdstuk overeen te komen</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
<span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># deze parameters maken de regelaar sneller of langzamer (of instabiel)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.23</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
<span class="n">freq_log</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span> <span class="c1"># intgang corrigeren met geschatte afwijking</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># foutvergelijking voor BPSK</span>

    <span class="c1"># fase- en frequentieafwijking opnieuw bepalen</span>
    <span class="n">freq</span> <span class="o">+=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">error</span><span class="p">)</span>
    <span class="n">freq_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="n">sample_rate</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="c1"># van rad/s naar Hz voor loggen</span>
    <span class="n">phase</span> <span class="o">+=</span> <span class="n">freq</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">error</span><span class="p">)</span>

    <span class="c1"># Fase tussen 0 and 2pi forceren</span>
    <span class="k">while</span> <span class="n">phase</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">phase</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">while</span> <span class="n">phase</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">phase</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">out</span>
</pre></div>
</div>
<p>We kopiëren ook de fijne frequentiesynchronisatie-code van het <a class="reference internal" href="sync.html#sync-chapter"><span class="std std-ref">Synchronisatie</span></a> hoofdstuk.
We gebruiken dus een Costas-loop om enig overgebleven frequentieafwijking te corrigeren, alsmede het BPSK uitlijnen met de reële (I) as.
Alles wat overblijft op de Q as komt waarschijnlijk door ruis, als de loop goed is afgesteld.
Laten we dezelfde animatie als eerder bekijken maar met de frequentiesynchronisatie toegepast (het is gestopt met draaien!):</p>
<a class="reference internal image-reference" href="../_images/constellation-animated-postcostas.gif"><img alt="../_images/constellation-animated-postcostas.gif" class="align-center" src="../_images/constellation-animated-postcostas.gif" style="width: 409.6px; height: 307.20000000000005px;" /></a>
<p>We kunnen ook nog de geschatte frequentieafwijking over de tijd weergeven om te zien hoe de Costas-loop werkt. We hadden dit immers opgeslagen in de code. Het lijkt op een afwijking van ongeveer 0.8 Hz, mogelijk veroorzaakt door een oscillatorafwijking bij de zender, maar waarschijnlijk bij de ontvanger. Wanneer je een eigen signaal gebruikt zul je <code class="code docutils literal notranslate"><span class="pre">alpha</span></code> en <code class="code docutils literal notranslate"><span class="pre">beta</span></code> moeten aanpassen totdat je een vergelijkbaar figuur krijgt. Het zou redelijk snel moeten afregelen met minimale oscillaties. Wat na steady-state overblijft is jitter, niet oscillaties.</p>
<a class="reference internal image-reference" href="../_images/freq_error.svg"><img alt="../_images/freq_error.svg" class="align-center" height="462" src="../_images/freq_error.svg" width="734" /></a>
</div>
<div class="section" id="bpsk-demoduleren">
<h2>BPSK demoduleren<a class="headerlink" href="#bpsk-demoduleren" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Demod BPSK</span>
<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># enen en nullen</span>
</pre></div>
</div>
<p>BPSK demoduleren is op dit punt erg simpel geworden. Omdat elk sample een <em>zacht</em> symbool voorstelt hoeven we alleen nog maar te kijken of de sample boven of onder de 0 is. Het stukje <code class="code docutils literal notranslate"><span class="pre">.astype(int)</span></code> is zodat we een array van getallen krijgen, in plaats van booleaanse variabelen. Als je je afvraagt of onder/boven de nul een 1 of een 0 voorstelt, dan zul je in de volgende sectie zien dat dit niet uitmaakt!</p>
</div>
<div class="section" id="differentieel-decoderen">
<h2>Differentieel decoderen<a class="headerlink" href="#differentieel-decoderen" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Differentieel decoderen, het maakt dan niet uit of alles 180 graden gedraaid is.</span>
<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="mi">2</span>
<span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="c1"># voor decoderen</span>
</pre></div>
</div>
<p>Toen het BPSK-signaal werd opgezet, is differentiële codering gebruikt. Dit betekent dat elke 1 en 0 van de originele data op zo’n manier is opgezet dat een bit verandering een 1 oplevert, en geen verandering een 0. Het grote voordeel van differentiële codering is dat je geen zorgen meer hebt over een mogelijke 180 graden fasedraaiing. Je kijkt dus niet meer of een 1 groter dan nul of minder dan nul moet zijn, je kijkt nu alleen of er een verschil is geweest tussen 1 en 0. Dit concept is misschien makkelijker te begrijpen door naar voorbeelddata te kijken. Hieronder zie je 10 symbolen voor en na differentiële decodering:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">]</span> <span class="c1"># voor differentiele decodering</span>
<span class="p">[</span><span class="o">-</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># na differentiele decodering</span>
</pre></div>
</div>
</div>
<div class="section" id="rds-decoderen">
<h2>RDS Decoderen<a class="headerlink" href="#rds-decoderen" title="Permalink to this headline">¶</a></h2>
<p>Nu we eindelijk onze bits aan informatie hebben kunnen we het gaan decoderen en zien wat het betekent.
Het enorme blok code wat hieronder is gegeven zullen we gebruiken om de 1’en en 0’en te decoderen naar groepen bytes.
Dit deel zou een stuk logischer worden al we eerst het zendende deel van RDS hadden gemaakt, maar accepteer voor nu dat RDS, groepen van 12 bytes gebruikt. De eerste 8 bytes geven de data aan, de laatste 4 bytes dienen voor synchronisatie. De laatste 4 bytes zijn niet noodzakelijk voor de volgende stap (het interpreteren van de data) dus dit wordt niet meegenomen in de uitgang.
Dit blok code neemt de 1’en en 0’en van hierboven en geeft aan de uitgang een lijst van bytes (in groepen van 8). Dit is handig voor de volgende stap waarbij we door de lijst gaan, per groep van 8 bytes.</p>
<p>Het grootste gedeelte van de onderstaande code draait om het synchroniseren en de foutcontrole.
Het werkt in blokken van 104 bits waarbij elk blok succesvol is ontvangen of fouten bevat (CRC controle). Elke 50 blokken controleert het of er meer dan 35 blokken een fout hadden, waarna het de synchronisatie probeert te herstarten.
De CRC wordt uitgevoerd met een 10-bits controle, met de polynoom <img class="math" src="../_images/math/721b9d55493e992ca626c983d273b567a24c1ae5.svg" alt="x^{10}+x^8+x^7+x^5+x^4+x^3+1"/>; dit vind plaats wanneer <code class="code docutils literal notranslate"><span class="pre">reg</span></code> met 0x5B9 wordt geXORt, het binaire equivalent van de polynoom.
In Python kun je bitoperaties uitvoeren met <code class="code docutils literal notranslate"><span class="pre">&amp;</span> <span class="pre">|</span> <span class="pre">~</span> <span class="pre">^</span></code> voor de functies [and, or, not, xor], net als in C/C++.
Een bitverschuiving naar links is <code class="code docutils literal notranslate"><span class="pre">x</span> <span class="pre">&lt;&lt;</span> <span class="pre">y</span></code> (het zelfde als x vermenigvuldigen met 2**y), en een bitverschuiving naar rechts is <code class="code docutils literal notranslate"><span class="pre">x</span> <span class="pre">&gt;&gt;</span> <span class="pre">y</span></code> (net als x delen door 2**y), net als in C/C++.</p>
<p>Je <strong>hoeft niet</strong> door alle code heen te lopen, of iets ervan, zeker als je focust op het leren van de fysieke (PHY) laag i.r.t. DSP en SDR, dit betreft <em>geen</em> signaalbewerking.
De code is simpelweg een implementatie van een RDS-decodering en alleen toepasbaar op het RDS protocol.
Als je al bent uitgeput door dit hoofdstuk, voel je dan vrij om dit enorme stuk code gewoon over te slaan.
Het heeft een vrij makkelijke functie maar lost het complex op.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Constants</span>
<span class="n">syndrome</span> <span class="o">=</span> <span class="p">[</span><span class="mi">383</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">663</span><span class="p">,</span> <span class="mi">748</span><span class="p">]</span>
<span class="n">offset_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">offset_word</span> <span class="o">=</span> <span class="p">[</span><span class="mi">252</span><span class="p">,</span> <span class="mi">408</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mi">436</span><span class="p">,</span> <span class="mi">848</span><span class="p">]</span>

<span class="c1"># see Annex B, page 64 of the standard</span>
<span class="k">def</span> <span class="nf">calc_syndrome</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mlen</span><span class="p">):</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">plen</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">plen</span><span class="p">)):</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">^</span> <span class="mh">0x5B9</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">plen</span><span class="p">)):</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">^</span> <span class="mh">0x5B9</span>
    <span class="k">return</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">plen</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># select the bottom plen bits of reg</span>

<span class="c1"># Initialize all the working vars we&#39;ll need during the loop</span>
<span class="n">synced</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">presync</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">wrong_blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">group_good_blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># was unsigned long in C++ (64 bits) but numpy doesn&#39;t support bitwise ops of uint64, I don&#39;t think it gets that high anyway</span>
<span class="n">lastseen_offset_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">lastseen_offset</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># the synchronization process is described in Annex C, page 66 of the standard */</span>
<span class="n">bytes_out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)):</span>
    <span class="c1"># in C++ reg doesn&#39;t get init so it will be random at first, for ours its 0s</span>
    <span class="c1"># It was also an unsigned long but never seemed to get anywhere near the max value</span>
    <span class="c1"># bits are either 0 or 1</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">left_shift</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># reg contains the last 26 rds bits. these are both bitwise ops</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">synced</span><span class="p">:</span>
        <span class="n">reg_syndrome</span> <span class="o">=</span> <span class="n">calc_syndrome</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reg_syndrome</span> <span class="o">==</span> <span class="n">syndrome</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">presync</span><span class="p">:</span>
                    <span class="n">lastseen_offset</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="n">lastseen_offset_counter</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">presync</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">lastseen_offset</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">block_distance</span> <span class="o">=</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">lastseen_offset</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">block_distance</span> <span class="o">=</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">lastseen_offset</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">block_distance</span><span class="o">*</span><span class="mi">26</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">lastseen_offset_counter</span><span class="p">):</span>
                        <span class="n">presync</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sync State Detected&#39;</span><span class="p">)</span>
                        <span class="n">wrong_blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">block_bit_counter</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">block_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
                        <span class="n">group_assembly_started</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">synced</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span> <span class="c1"># syndrome found, no more cycles</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># SYNCED</span>
        <span class="c1"># wait until 26 bits enter the buffer */</span>
        <span class="k">if</span> <span class="n">block_bit_counter</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>
            <span class="n">block_bit_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">good_block</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">dataword</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
            <span class="n">block_calculated_crc</span> <span class="o">=</span> <span class="n">calc_syndrome</span><span class="p">(</span><span class="n">dataword</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">checkword</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span>
            <span class="k">if</span> <span class="n">block_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># manage special case of C or C&#39; offset word</span>
                <span class="n">block_received_crc</span> <span class="o">=</span> <span class="n">checkword</span> <span class="o">^</span> <span class="n">offset_word</span><span class="p">[</span><span class="n">block_number</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">block_received_crc</span> <span class="o">==</span> <span class="n">block_calculated_crc</span><span class="p">):</span>
                    <span class="n">good_block</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">block_received_crc</span> <span class="o">=</span> <span class="n">checkword</span> <span class="o">^</span> <span class="n">offset_word</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">block_received_crc</span> <span class="o">==</span> <span class="n">block_calculated_crc</span><span class="p">):</span>
                        <span class="n">good_block</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wrong_blocks_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">good_block</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">block_received_crc</span> <span class="o">=</span> <span class="n">checkword</span> <span class="o">^</span> <span class="n">offset_word</span><span class="p">[</span><span class="n">block_number</span><span class="p">]</span> <span class="c1"># bitwise xor</span>
                <span class="k">if</span> <span class="n">block_received_crc</span> <span class="o">==</span> <span class="n">block_calculated_crc</span><span class="p">:</span>
                    <span class="n">good_block</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wrong_blocks_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">good_block</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Done checking CRC</span>
            <span class="k">if</span> <span class="n">block_number</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">good_block</span><span class="p">:</span>
                <span class="n">group_assembly_started</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">group_good_blocks_counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># 8 bytes filled with 0s</span>
            <span class="k">if</span> <span class="n">group_assembly_started</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">good_block</span><span class="p">:</span>
                    <span class="n">group_assembly_started</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># raw data bytes, as received from RDS. 8 info bytes, followed by 4 RDS offset chars: ABCD/ABcD/EEEE (in US) which we leave out here</span>
                    <span class="c1"># RDS information words</span>
                    <span class="c1"># block_number is either 0,1,2,3 so this is how we fill out the 8 bytes</span>
                    <span class="nb">bytes</span><span class="p">[</span><span class="n">block_number</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataword</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span>
                    <span class="nb">bytes</span><span class="p">[</span><span class="n">block_number</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataword</span> <span class="o">&amp;</span> <span class="mi">255</span>
                    <span class="n">group_good_blocks_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1">#print(&#39;group_good_blocks_counter:&#39;, group_good_blocks_counter)</span>
                <span class="k">if</span> <span class="n">group_good_blocks_counter</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="c1">#print(bytes)</span>
                    <span class="n">bytes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="c1"># list of len-8 lists of bytes</span>
            <span class="n">block_bit_counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">block_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
            <span class="n">blocks_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">blocks_counter</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wrong_blocks_counter</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">:</span> <span class="c1"># This many wrong blocks must mean we lost sync</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lost Sync (Got &quot;</span><span class="p">,</span> <span class="n">wrong_blocks_counter</span><span class="p">,</span> <span class="s2">&quot; bad blocks on &quot;</span><span class="p">,</span> <span class="n">blocks_counter</span><span class="p">,</span> <span class="s2">&quot; total)&quot;</span><span class="p">)</span>
                    <span class="n">synced</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">presync</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Still Sync-ed (Got &quot;</span><span class="p">,</span> <span class="n">wrong_blocks_counter</span><span class="p">,</span> <span class="s2">&quot; bad blocks on &quot;</span><span class="p">,</span> <span class="n">blocks_counter</span><span class="p">,</span> <span class="s2">&quot; total)&quot;</span><span class="p">)</span>
                <span class="n">blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">wrong_blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Hieronder zie je een voorbeelduitgang van deze stap. Het voorbeeld synchroniseert snel maar verliest de synchronisatie een paar keer om een of andere reden. Het kan nog steeds de data goed interpreteren zoals we later zien. Als je het downloadbare FM-signaal gebruikt zul je slechts de eerste paar regels van hieronder zien. De echte inhoud van de bytes lijkt gewoon op willekeurige nummers/karakters afhankelijk van hoe je ze weergeeft. In de volgende stap zetten we het om naar leesbare informatie!</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">Sync State Detected</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  1  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  5  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  26  bad blocks on  50  total)</span>
<span class="go">Lost Sync (Got  50  bad blocks on  50  total)</span>
<span class="go">Sync State Detected</span>
<span class="go">Still Sync-ed (Got  3  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  0  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  2  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  1  bad blocks on  50  total)</span>
<span class="go">Still Sync-ed (Got  20  bad blocks on  50  total)</span>
<span class="go">Lost Sync (Got  47  bad blocks on  50  total)</span>
<span class="go">Sync State Detected</span>
<span class="go">Still Sync-ed (Got  32  bad blocks on  50  total)</span>
</pre></div>
</div>
</div>
<div class="section" id="rds-interpreteren">
<h2>RDS Interpreteren<a class="headerlink" href="#rds-interpreteren" title="Permalink to this headline">¶</a></h2>
<p>Nu we de bytes in groepen van 8 hebben verkregen, kunnen we de uiteindelijke data extraheren.
Dit wordt ook wel “parsen” genoemd en net als het vorige blok code is dit simpelweg een implementatie van het RDS-protocol, en niet belangrijk om te begrijpen. Gelukkig is het niet een groot stuk code als je de eerste twee tabellen weglaat. Dit zijn alleen look-up tabellen voor het type FM-kanaal en het dekkingsgebied.</p>
<p>Als je toch geïnteresseerd bent in hoe deze code werkt, geef ik hier wat extra informatie. Het protocol gebruikt het A/B vlaggetjes concept. Dit betekent dat sommige berichten gemarkeerd worden met een A en anderen met een B. Het interpreteren van de data hangt dan af van de vlag, deze is te vinden in de derde bit van de tweede byte. Het gebruikt ook verschillende type groepen wat gelijk is aan een berichttype. Hieronder bekijken we alleen berichten van type 2 wat de tekst bevat die het radiostation doorstuurt en wat je voorbij ziet komen op de autoradio.
Het kanaaltype en de regio kunnen we nog steeds vinden omdat dit in elk bericht zit.
Als laatste is het goed om te weten dat de string <code class="code docutils literal notranslate"><span class="pre">radiotext</span></code> wordt geinitialiseerd met alleen maar spaties. Het wordt langzaam opgevuld terwijl de data wordt geïnterpreteerd en wordt weer nul bij het ontvangen van een speciale reeks bytes.
Andere mogelijke berichttypes zijn [“BASIC”, “PIN/SL”, “RT”, “AID”, “CT”, “TDC”, “IH”, “RP”, “TMC”, “EWS”, “EON”]. Het type “RT” is radiotext wat wij hieronder decoderen. Het RDS GNU Radio block geeft “BASIC” ook terug, maar met de stations die ik heb getest zat daar geen interessante informatie in, terwijl het onderstaande code wel een stuk groter zou maken.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Annex F of RBDS Standard Table F.1 (North America) and Table F.2 (Europe)</span>
<span class="c1">#              Europe                   North America</span>
<span class="n">pty_table</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>             <span class="s2">&quot;Undefined&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;News&quot;</span><span class="p">,</span>                  <span class="s2">&quot;News&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Current Affairs&quot;</span><span class="p">,</span>       <span class="s2">&quot;Information&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Information&quot;</span><span class="p">,</span>           <span class="s2">&quot;Sports&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Sport&quot;</span><span class="p">,</span>                 <span class="s2">&quot;Talk&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Education&quot;</span><span class="p">,</span>             <span class="s2">&quot;Rock&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Drama&quot;</span><span class="p">,</span>                 <span class="s2">&quot;Classic Rock&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">,</span>               <span class="s2">&quot;Adult Hits&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Science&quot;</span><span class="p">,</span>               <span class="s2">&quot;Soft Rock&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Varied&quot;</span><span class="p">,</span>                <span class="s2">&quot;Top 40&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Pop Music&quot;</span><span class="p">,</span>             <span class="s2">&quot;Country&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Rock Music&quot;</span><span class="p">,</span>            <span class="s2">&quot;Oldies&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Easy Listening&quot;</span><span class="p">,</span>        <span class="s2">&quot;Soft&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Light Classical&quot;</span><span class="p">,</span>       <span class="s2">&quot;Nostalgia&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Serious Classical&quot;</span><span class="p">,</span>     <span class="s2">&quot;Jazz&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Other Music&quot;</span><span class="p">,</span>           <span class="s2">&quot;Classical&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Weather&quot;</span><span class="p">,</span>               <span class="s2">&quot;Rhythm &amp; Blues&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Finance&quot;</span><span class="p">,</span>               <span class="s2">&quot;Soft Rhythm &amp; Blues&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Children’s Programmes&quot;</span><span class="p">,</span> <span class="s2">&quot;Language&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Social Affairs&quot;</span><span class="p">,</span>        <span class="s2">&quot;Religious Music&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Religion&quot;</span><span class="p">,</span>              <span class="s2">&quot;Religious Talk&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Phone-In&quot;</span><span class="p">,</span>              <span class="s2">&quot;Personality&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Travel&quot;</span><span class="p">,</span>                <span class="s2">&quot;Public&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Leisure&quot;</span><span class="p">,</span>               <span class="s2">&quot;College&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Jazz Music&quot;</span><span class="p">,</span>            <span class="s2">&quot;Spanish Talk&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Country Music&quot;</span><span class="p">,</span>         <span class="s2">&quot;Spanish Music&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;National Music&quot;</span><span class="p">,</span>        <span class="s2">&quot;Hip Hop&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Oldies Music&quot;</span><span class="p">,</span>          <span class="s2">&quot;Unassigned&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Folk Music&quot;</span><span class="p">,</span>            <span class="s2">&quot;Unassigned&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Documentary&quot;</span><span class="p">,</span>           <span class="s2">&quot;Weather&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Alarm Test&quot;</span><span class="p">,</span>            <span class="s2">&quot;Emergency Test&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Alarm&quot;</span><span class="p">,</span>                 <span class="s2">&quot;Emergency&quot;</span><span class="p">]]</span>
<span class="n">pty_locale</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># set to 0 for Europe which will use first column instead</span>

<span class="c1"># page 72, Annex D, table D.2 in the standard</span>
<span class="n">coverage_area_codes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Local&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;International&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;National&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Supra-regional&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 1&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 2&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 3&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 4&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 5&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 6&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 7&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 8&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 9&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 10&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 11&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 12&quot;</span><span class="p">]</span>

<span class="n">radiotext_AB_flag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">radiotext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">65</span>
<span class="n">first_time</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">for</span> <span class="nb">bytes</span> <span class="ow">in</span> <span class="n">bytes_out</span><span class="p">:</span>
    <span class="n">group_0</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">group_1</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">group_2</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">group_3</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">group_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span> <span class="c1"># here is what each one means, e.g. RT is radiotext which is the only one we decode here: [&quot;BASIC&quot;, &quot;PIN/SL&quot;, &quot;RT&quot;, &quot;AID&quot;, &quot;CT&quot;, &quot;TDC&quot;, &quot;IH&quot;, &quot;RP&quot;, &quot;TMC&quot;, &quot;EWS&quot;, &quot;___&quot;, &quot;___&quot;, &quot;___&quot;, &quot;___&quot;, &quot;EON&quot;, &quot;___&quot;]</span>
    <span class="n">AB</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="c1"># b if 1, a if 0</span>

    <span class="c1">#print(&quot;group_type:&quot;, group_type) # this is essentially message type, i only see type 0 and 2 in my recording</span>
    <span class="c1">#print(&quot;AB:&quot;, AB)</span>

    <span class="n">program_identification</span> <span class="o">=</span> <span class="n">group_0</span>     <span class="c1"># &quot;PI&quot;</span>

    <span class="n">program_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="c1"># &quot;PTY&quot;</span>
    <span class="n">pty</span> <span class="o">=</span> <span class="n">pty_table</span><span class="p">[</span><span class="n">program_type</span><span class="p">][</span><span class="n">pty_locale</span><span class="p">]</span>

    <span class="n">pi_area_coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">program_identification</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span>
    <span class="n">coverage_area</span> <span class="o">=</span> <span class="n">coverage_area_codes</span><span class="p">[</span><span class="n">pi_area_coverage</span><span class="p">]</span>

    <span class="n">pi_program_reference_number</span> <span class="o">=</span> <span class="n">program_identification</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="c1"># just an int</span>

    <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PTY:&quot;</span><span class="p">,</span> <span class="n">pty</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;program:&quot;</span><span class="p">,</span> <span class="n">pi_program_reference_number</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coverage_area:&quot;</span><span class="p">,</span> <span class="n">coverage_area</span><span class="p">)</span>
        <span class="n">first_time</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">group_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># when the A/B flag is toggled, flush your current radiotext</span>
        <span class="k">if</span> <span class="n">radiotext_AB_flag</span> <span class="o">!=</span> <span class="p">((</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">):</span>
            <span class="n">radiotext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">65</span>
        <span class="n">radiotext_AB_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span>
        <span class="n">text_segment_address_code</span> <span class="o">=</span> <span class="n">group_1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>
        <span class="k">if</span> <span class="n">AB</span><span class="p">:</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">2</span>    <span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="n">group_3</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">group_3</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span><span class="mi">4</span>     <span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="n">group_2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">group_2</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="n">group_3</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">group_3</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">radiotext</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1">#print(&quot;unsupported group_type:&quot;, group_type)</span>
</pre></div>
</div>
<p>Hieronder zie je het resultaat met het downloadbare FM-signaal. Je ziet hoe het de radiostring opbouwt over meerdere berichten.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">PTY: Pop Music</span>
<span class="go">program: 199</span>
<span class="go">coverage_area: Supra-regional</span>

<span class="go">OnAi</span>
<span class="go">OnAir: L</span>
<span class="go">OnAir: Lionh</span>
<span class="go">OnAir: Lionheart</span>
<span class="go">OnAir: Lionheart (fe</span>
<span class="go">OnAir: Lionheart (fearle</span>
<span class="go">OnAir: Lionheart (fearless)</span>
<span class="go">OnAir: Lionheart (fearless) - Jo</span>
<span class="go">OnAir: Lionheart (fearless) - Joel C</span>
<span class="go">OnAir: Lionheart (fearless) - Joel Corry</span>
<span class="go">OnAir: Lionheart (fearless) - Joel Corry &amp; T</span>
<span class="go">OnAir: Lionheart (fearless) - Joel Corry &amp; Tom G</span>
<span class="go">OnAir: Lionheart (fearless) - Joel Corry &amp; Tom Grenn</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
<span class="go">        nheart (fearless) - Joel Corry &amp; Tom Grennan</span>
</pre></div>
</div>
</div>
<div class="section" id="laatste-code">
<h2>Laatste code<a class="headerlink" href="#laatste-code" title="Permalink to this headline">¶</a></h2>
<p>Het is af! Alle bovenstaande code is samengevoegd tot de code hieronder. Het zou moeten werken met de <a class="reference external" href="https://github.com/versd/pysdr/blob/dutch/fm_1027mhz_250ksps?raw=true" rel="noopener noreferrer" target="_blank">FM opname die je hier kunt vinden</a> . Je zou ook je eigen signaal moeten kunnen gebruiken zolang de SNR hoog genoeg is, de middenfrequentie goed is afgesteld en je een samplefrequentie van 250 kHz hebt gebruikt.
Mocht je de code moeten tweaken om het werkend te krijgen met jouw opname of SDR, laat me dan weten wat je moest doen en je kunt het insturen als een pull-request op de <a class="reference external" href="https://github.com/777arc/textbook" rel="noopener noreferrer" target="_blank">GitHub pagina</a>. Ook is <a class="reference external" href="https://github.com/777arc/textbook/blob/master/figure-generating-scripts/rds_demo.py" rel="noopener noreferrer" target="_blank">hier</a> een versie te vinden met een hoop code om de figuren uit dit hoofdstuk te genereren.</p>
<details>
<summary>Uiteindelijke Code</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">resample_poly</span><span class="p">,</span> <span class="n">firwin</span><span class="p">,</span> <span class="n">bilinear</span><span class="p">,</span> <span class="n">lfilter</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Read in signal</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="s1">&#39;/home/versd/Downloads/fm_1027mhz_250ksps&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">complex64</span><span class="p">)</span>
<span class="n">sample_rate</span> <span class="o">=</span> <span class="mf">250e3</span>
<span class="n">center_freq</span> <span class="o">=</span> <span class="mf">102.7e6</span>

<span class="c1"># Kwadratuur Demod</span>
<span class="n">x</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span> <span class="c1"># zie https://wiki.gnuradio.org/index.php/Quadrature_Demod</span>

<span class="c1"># Freq verschuiven</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">f_o</span> <span class="o">=</span> <span class="o">-</span><span class="mf">57e3</span> <span class="c1"># hoeveelheid in Hz</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="n">sample_rate</span> <span class="c1"># tijdvector</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f_o</span><span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="c1"># verschuiving</span>

<span class="c1"># laagdoorlaatfilter</span>
<span class="n">taps</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">7.5e3</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">taps</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>

<span class="c1"># Geen vouwvervorming meer dankzij het filter, nu decimeren met 10</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="mi">10</span><span class="p">]</span>
<span class="n">sample_rate</span> <span class="o">=</span> <span class="mf">25e3</span>

<span class="c1"># Hersamplen naar 19kHz</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">resample_poly</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="c1"># omhoog, beneden</span>
<span class="n">sample_rate</span> <span class="o">=</span> <span class="mf">19e3</span>

<span class="c1"># Banddoorlaatfilter om 1 RDS BPSK signaal te isoleren</span>
<span class="n">taps</span> <span class="o">=</span> <span class="n">firwin</span><span class="p">(</span><span class="n">numtaps</span><span class="o">=</span><span class="mi">501</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05e3</span><span class="p">,</span> <span class="mf">2e3</span><span class="p">],</span> <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span> <span class="n">pass_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">taps</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>

<span class="c1"># Symbol sync, zoals uit het synchronisatie hoofdstuk sync chapter</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">x</span> <span class="c1"># zodat we met het synchronisatie hoofdstuk overeenkomen</span>
<span class="n">samples_interpolated</span> <span class="o">=</span> <span class="n">resample_poly</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># we interpoleren met 32, dit lijkt beter te werken dan 16</span>
<span class="n">sps</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># eerste inschatting van faseafwijking</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
<span class="n">out_rail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span> <span class="c1"># oude waardes opslaan</span>
<span class="n">i_in</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># input samples index</span>
<span class="n">i_out</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># output index (eerste twee zijn 0)</span>
<span class="k">while</span> <span class="n">i_out</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i_in</span><span class="o">+</span><span class="mi">32</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
    <span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples_interpolated</span><span class="p">[</span><span class="n">i_in</span><span class="o">*</span><span class="mi">32</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="mi">32</span><span class="p">)]</span> <span class="c1">#neem het `beste` sample</span>
    <span class="n">out_rail</span><span class="p">[</span><span class="n">i_out</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">out_rail</span><span class="p">[</span><span class="n">i_out</span><span class="p">]</span> <span class="o">-</span> <span class="n">out_rail</span><span class="p">[</span><span class="n">i_out</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="p">]</span> <span class="o">-</span> <span class="n">out</span><span class="p">[</span><span class="n">i_out</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">out_rail</span><span class="p">[</span><span class="n">i_out</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">mm_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">+=</span> <span class="n">sps</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">mm_val</span>
    <span class="n">i_in</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span> <span class="c1"># afronden naar geheel getal</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="c1"># fractie berekenen</span>
    <span class="n">i_out</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># output index verhogen</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">i_out</span><span class="p">]</span> <span class="c1"># pak alleen de nuttige data</span>

<span class="n">sample_rate</span> <span class="o">/=</span> <span class="mi">16</span> <span class="c1"># nu krijgen we 1187.5 kHz</span>

<span class="c1">#Fijne freq sync</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">x</span> <span class="c1"># om met het sync hoofdstuk overeen te komen</span>
<span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
<span class="n">phase</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># deze parameters maken de regelaar sneller of langzamer (of instabiel)</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.23</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex64</span><span class="p">)</span>
<span class="n">freq_log</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
    <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">phase</span><span class="p">)</span> <span class="c1"># intgang corrigeren met geschatte afwijking</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># foutvergelijking voor BPSK</span>

    <span class="c1"># fase- en frequentieafwijking opnieuw bepalen</span>
    <span class="n">freq</span> <span class="o">+=</span> <span class="p">(</span><span class="n">beta</span> <span class="o">*</span> <span class="n">error</span><span class="p">)</span>
    <span class="n">freq_log</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="n">sample_rate</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="c1"># van rad/s naar Hz voor loggen</span>
    <span class="n">phase</span> <span class="o">+=</span> <span class="n">freq</span> <span class="o">+</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">error</span><span class="p">)</span>

    <span class="c1"># Fase tussen 0 and 2pi forceren</span>
    <span class="k">while</span> <span class="n">phase</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">phase</span> <span class="o">-=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">while</span> <span class="n">phase</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">phase</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">out</span>

<span class="c1"># Demod BPSK</span>
<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span> <span class="c1"># enen en nullen</span>

<span class="c1"># Differentieel decoderen, het maakt dan niet uit of alles 180 graden gedraaid is.</span>
<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">bits</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="mi">2</span>
<span class="n">bits</span> <span class="o">=</span> <span class="n">bits</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span> <span class="c1"># voor decoderen</span>

<span class="c1">###########</span>
<span class="c1"># DECODER #</span>
<span class="c1">###########</span>

<span class="c1"># Constants</span>
<span class="n">syndrome</span> <span class="o">=</span> <span class="p">[</span><span class="mi">383</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">303</span><span class="p">,</span> <span class="mi">663</span><span class="p">,</span> <span class="mi">748</span><span class="p">]</span>
<span class="n">offset_pos</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">offset_word</span> <span class="o">=</span> <span class="p">[</span><span class="mi">252</span><span class="p">,</span> <span class="mi">408</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="mi">436</span><span class="p">,</span> <span class="mi">848</span><span class="p">]</span>

<span class="c1"># see Annex B, page 64 of the standard</span>
<span class="k">def</span> <span class="nf">calc_syndrome</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mlen</span><span class="p">):</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">plen</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">plen</span><span class="p">)):</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">^</span> <span class="mh">0x5B9</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">plen</span><span class="p">)):</span>
            <span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">^</span> <span class="mh">0x5B9</span>
    <span class="k">return</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">plen</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># select the bottom plen bits of reg</span>

<span class="c1"># Initialize all the working vars we&#39;ll need during the loop</span>
<span class="n">synced</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">presync</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">wrong_blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">group_good_blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># was unsigned long in C++ (64 bits) but numpy doesn&#39;t support bitwise ops of uint64, I don&#39;t think it gets that high anyway</span>
<span class="n">lastseen_offset_counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">lastseen_offset</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># the synchronization process is described in Annex C, page 66 of the standard */</span>
<span class="n">bytes_out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bits</span><span class="p">)):</span>
    <span class="c1"># in C++ reg doesn&#39;t get init so it will be random at first, for ours its 0s</span>
    <span class="c1"># It was also an unsigned long but never seemed to get anywhere near the max value</span>
    <span class="c1"># bits are either 0 or 1</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bitwise_or</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">left_shift</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="c1"># reg contains the last 26 rds bits. these are both bitwise ops</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">synced</span><span class="p">:</span>
        <span class="n">reg_syndrome</span> <span class="o">=</span> <span class="n">calc_syndrome</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="mi">26</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">reg_syndrome</span> <span class="o">==</span> <span class="n">syndrome</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">presync</span><span class="p">:</span>
                    <span class="n">lastseen_offset</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="n">lastseen_offset_counter</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">presync</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">lastseen_offset</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">block_distance</span> <span class="o">=</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">lastseen_offset</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">block_distance</span> <span class="o">=</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset_pos</span><span class="p">[</span><span class="n">lastseen_offset</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">block_distance</span><span class="o">*</span><span class="mi">26</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">lastseen_offset_counter</span><span class="p">):</span>
                        <span class="n">presync</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Sync State Detected&#39;</span><span class="p">)</span>
                        <span class="n">wrong_blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">block_bit_counter</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">block_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
                        <span class="n">group_assembly_started</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">synced</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span> <span class="c1"># syndrome found, no more cycles</span>

    <span class="k">else</span><span class="p">:</span> <span class="c1"># SYNCED</span>
        <span class="c1"># wait until 26 bits enter the buffer */</span>
        <span class="k">if</span> <span class="n">block_bit_counter</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>
            <span class="n">block_bit_counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">good_block</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">dataword</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span>
            <span class="n">block_calculated_crc</span> <span class="o">=</span> <span class="n">calc_syndrome</span><span class="p">(</span><span class="n">dataword</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
            <span class="n">checkword</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span>
            <span class="k">if</span> <span class="n">block_number</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># manage special case of C or C&#39; offset word</span>
                <span class="n">block_received_crc</span> <span class="o">=</span> <span class="n">checkword</span> <span class="o">^</span> <span class="n">offset_word</span><span class="p">[</span><span class="n">block_number</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">block_received_crc</span> <span class="o">==</span> <span class="n">block_calculated_crc</span><span class="p">):</span>
                    <span class="n">good_block</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">block_received_crc</span> <span class="o">=</span> <span class="n">checkword</span> <span class="o">^</span> <span class="n">offset_word</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">block_received_crc</span> <span class="o">==</span> <span class="n">block_calculated_crc</span><span class="p">):</span>
                        <span class="n">good_block</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wrong_blocks_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">good_block</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">block_received_crc</span> <span class="o">=</span> <span class="n">checkword</span> <span class="o">^</span> <span class="n">offset_word</span><span class="p">[</span><span class="n">block_number</span><span class="p">]</span> <span class="c1"># bitwise xor</span>
                <span class="k">if</span> <span class="n">block_received_crc</span> <span class="o">==</span> <span class="n">block_calculated_crc</span><span class="p">:</span>
                    <span class="n">good_block</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wrong_blocks_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">good_block</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Done checking CRC</span>
            <span class="k">if</span> <span class="n">block_number</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">good_block</span><span class="p">:</span>
                <span class="n">group_assembly_started</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">group_good_blocks_counter</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># 8 bytes filled with 0s</span>
            <span class="k">if</span> <span class="n">group_assembly_started</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">good_block</span><span class="p">:</span>
                    <span class="n">group_assembly_started</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># raw data bytes, as received from RDS. 8 info bytes, followed by 4 RDS offset chars: ABCD/ABcD/EEEE (in US) which we leave out here</span>
                    <span class="c1"># RDS information words</span>
                    <span class="c1"># block_number is either 0,1,2,3 so this is how we fill out the 8 bytes</span>
                    <span class="nb">bytes</span><span class="p">[</span><span class="n">block_number</span><span class="o">*</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dataword</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">255</span>
                    <span class="nb">bytes</span><span class="p">[</span><span class="n">block_number</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataword</span> <span class="o">&amp;</span> <span class="mi">255</span>
                    <span class="n">group_good_blocks_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="c1">#print(&#39;group_good_blocks_counter:&#39;, group_good_blocks_counter)</span>
                <span class="k">if</span> <span class="n">group_good_blocks_counter</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                    <span class="c1">#print(bytes)</span>
                    <span class="n">bytes_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span> <span class="c1"># list of len-8 lists of bytes</span>
            <span class="n">block_bit_counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">block_number</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span>
            <span class="n">blocks_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">blocks_counter</span> <span class="o">==</span> <span class="mi">50</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">wrong_blocks_counter</span> <span class="o">&gt;</span> <span class="mi">35</span><span class="p">:</span> <span class="c1"># This many wrong blocks must mean we lost sync</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lost Sync (Got &quot;</span><span class="p">,</span> <span class="n">wrong_blocks_counter</span><span class="p">,</span> <span class="s2">&quot; bad blocks on &quot;</span><span class="p">,</span> <span class="n">blocks_counter</span><span class="p">,</span> <span class="s2">&quot; total)&quot;</span><span class="p">)</span>
                    <span class="n">synced</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">presync</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Still Sync-ed (Got &quot;</span><span class="p">,</span> <span class="n">wrong_blocks_counter</span><span class="p">,</span> <span class="s2">&quot; bad blocks on &quot;</span><span class="p">,</span> <span class="n">blocks_counter</span><span class="p">,</span> <span class="s2">&quot; total)&quot;</span><span class="p">)</span>
                <span class="n">blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">wrong_blocks_counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1">###########</span>
<span class="c1"># PARSER  #</span>
<span class="c1">###########</span>

<span class="c1"># Annex F of RBDS Standard Table F.1 (North America) and Table F.2 (Europe)</span>
<span class="c1">#              Europe                   North America</span>
<span class="n">pty_table</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;Undefined&quot;</span><span class="p">,</span>             <span class="s2">&quot;Undefined&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;News&quot;</span><span class="p">,</span>                  <span class="s2">&quot;News&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Current Affairs&quot;</span><span class="p">,</span>       <span class="s2">&quot;Information&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Information&quot;</span><span class="p">,</span>           <span class="s2">&quot;Sports&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Sport&quot;</span><span class="p">,</span>                 <span class="s2">&quot;Talk&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Education&quot;</span><span class="p">,</span>             <span class="s2">&quot;Rock&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Drama&quot;</span><span class="p">,</span>                 <span class="s2">&quot;Classic Rock&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Culture&quot;</span><span class="p">,</span>               <span class="s2">&quot;Adult Hits&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Science&quot;</span><span class="p">,</span>               <span class="s2">&quot;Soft Rock&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Varied&quot;</span><span class="p">,</span>                <span class="s2">&quot;Top 40&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Pop Music&quot;</span><span class="p">,</span>             <span class="s2">&quot;Country&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Rock Music&quot;</span><span class="p">,</span>            <span class="s2">&quot;Oldies&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Easy Listening&quot;</span><span class="p">,</span>        <span class="s2">&quot;Soft&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Light Classical&quot;</span><span class="p">,</span>       <span class="s2">&quot;Nostalgia&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Serious Classical&quot;</span><span class="p">,</span>     <span class="s2">&quot;Jazz&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Other Music&quot;</span><span class="p">,</span>           <span class="s2">&quot;Classical&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Weather&quot;</span><span class="p">,</span>               <span class="s2">&quot;Rhythm &amp; Blues&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Finance&quot;</span><span class="p">,</span>               <span class="s2">&quot;Soft Rhythm &amp; Blues&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Children’s Programmes&quot;</span><span class="p">,</span> <span class="s2">&quot;Language&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Social Affairs&quot;</span><span class="p">,</span>        <span class="s2">&quot;Religious Music&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Religion&quot;</span><span class="p">,</span>              <span class="s2">&quot;Religious Talk&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Phone-In&quot;</span><span class="p">,</span>              <span class="s2">&quot;Personality&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Travel&quot;</span><span class="p">,</span>                <span class="s2">&quot;Public&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Leisure&quot;</span><span class="p">,</span>               <span class="s2">&quot;College&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Jazz Music&quot;</span><span class="p">,</span>            <span class="s2">&quot;Spanish Talk&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Country Music&quot;</span><span class="p">,</span>         <span class="s2">&quot;Spanish Music&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;National Music&quot;</span><span class="p">,</span>        <span class="s2">&quot;Hip Hop&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Oldies Music&quot;</span><span class="p">,</span>          <span class="s2">&quot;Unassigned&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Folk Music&quot;</span><span class="p">,</span>            <span class="s2">&quot;Unassigned&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Documentary&quot;</span><span class="p">,</span>           <span class="s2">&quot;Weather&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Alarm Test&quot;</span><span class="p">,</span>            <span class="s2">&quot;Emergency Test&quot;</span><span class="p">],</span>
             <span class="p">[</span><span class="s2">&quot;Alarm&quot;</span><span class="p">,</span>                 <span class="s2">&quot;Emergency&quot;</span><span class="p">]]</span>
<span class="n">pty_locale</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># set to 0 for Europe which will use first column instead</span>

<span class="c1"># page 72, Annex D, table D.2 in the standard</span>
<span class="n">coverage_area_codes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Local&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;International&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;National&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Supra-regional&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 1&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 2&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 3&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 4&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 5&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 6&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 7&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 8&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 9&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 10&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 11&quot;</span><span class="p">,</span>
                       <span class="s2">&quot;Regional 12&quot;</span><span class="p">]</span>

<span class="n">radiotext_AB_flag</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">radiotext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">65</span>
<span class="n">first_time</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">for</span> <span class="nb">bytes</span> <span class="ow">in</span> <span class="n">bytes_out</span><span class="p">:</span>
    <span class="n">group_0</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">group_1</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">group_2</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="n">group_3</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">group_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span> <span class="c1"># here is what each one means, e.g. RT is radiotext which is the only one we decode here: [&quot;BASIC&quot;, &quot;PIN/SL&quot;, &quot;RT&quot;, &quot;AID&quot;, &quot;CT&quot;, &quot;TDC&quot;, &quot;IH&quot;, &quot;RP&quot;, &quot;TMC&quot;, &quot;EWS&quot;, &quot;___&quot;, &quot;___&quot;, &quot;___&quot;, &quot;___&quot;, &quot;EON&quot;, &quot;___&quot;]</span>
    <span class="n">AB</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span> <span class="c1"># b if 1, a if 0</span>

    <span class="c1">#print(&quot;group_type:&quot;, group_type) # this is essentially message type, i only see type 0 and 2 in my recording</span>
    <span class="c1">#print(&quot;AB:&quot;, AB)</span>

    <span class="n">program_identification</span> <span class="o">=</span> <span class="n">group_0</span>     <span class="c1"># &quot;PI&quot;</span>

    <span class="n">program_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span> <span class="c1"># &quot;PTY&quot;</span>
    <span class="n">pty</span> <span class="o">=</span> <span class="n">pty_table</span><span class="p">[</span><span class="n">program_type</span><span class="p">][</span><span class="n">pty_locale</span><span class="p">]</span>

    <span class="n">pi_area_coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">program_identification</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span>
    <span class="n">coverage_area</span> <span class="o">=</span> <span class="n">coverage_area_codes</span><span class="p">[</span><span class="n">pi_area_coverage</span><span class="p">]</span>

    <span class="n">pi_program_reference_number</span> <span class="o">=</span> <span class="n">program_identification</span> <span class="o">&amp;</span> <span class="mh">0xff</span> <span class="c1"># just an int</span>

    <span class="k">if</span> <span class="n">first_time</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;PTY:&quot;</span><span class="p">,</span> <span class="n">pty</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;program:&quot;</span><span class="p">,</span> <span class="n">pi_program_reference_number</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;coverage_area:&quot;</span><span class="p">,</span> <span class="n">coverage_area</span><span class="p">)</span>
        <span class="n">first_time</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">group_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># when the A/B flag is toggled, flush your current radiotext</span>
        <span class="k">if</span> <span class="n">radiotext_AB_flag</span> <span class="o">!=</span> <span class="p">((</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">):</span>
            <span class="n">radiotext</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">65</span>
        <span class="n">radiotext_AB_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">group_1</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span>
        <span class="n">text_segment_address_code</span> <span class="o">=</span> <span class="n">group_1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>
        <span class="k">if</span> <span class="n">AB</span><span class="p">:</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">2</span>    <span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="n">group_3</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">group_3</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span><span class="mi">4</span>     <span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="n">group_2</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">group_2</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">((</span><span class="n">group_3</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
            <span class="n">radiotext</span><span class="p">[</span><span class="n">text_segment_address_code</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">group_3</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">radiotext</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
        <span class="c1">#print(&quot;unsupported group_type:&quot;, group_type)</span>
</pre></div>
</div>
</details><p>Als je het audiosignaal ook wilt demoduleren kun je dit toevoegen nadat je het signaal hebt ontvangen, met dank aan <a class="reference external" href="http://github.com/joeugenio" rel="noopener noreferrer" target="_blank">Joel Cordeiro</a> voor de code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Add the following code right after the &quot;Acquiring a Signal&quot; section</span>

<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">wavfile</span>

<span class="c1"># Demodulation</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>

<span class="c1"># De-emphasis filter, H(s) = 1/(RC*s + 1), implemented as IIR via bilinear transform</span>
<span class="n">bz</span><span class="p">,</span> <span class="n">az</span> <span class="o">=</span> <span class="n">bilinear</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mf">75e-6</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">fs</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">lfilter</span><span class="p">(</span><span class="n">bz</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># decimate filter to get mono audio</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="mi">6</span><span class="p">]</span>
<span class="n">sample_rate</span> <span class="o">=</span> <span class="n">sample_rate</span><span class="o">/</span><span class="mi">6</span>

<span class="c1"># normalizes volume</span>
<span class="n">x</span> <span class="o">/=</span> <span class="n">x</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

<span class="c1"># Save to wav file, you can open this in Audacity for example</span>
<span class="n">wavfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;fm.wav&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample_rate</span><span class="p">),</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>Het meest ingewikkelde deel is het de-emphasis filter, <a class="reference external" href="https://wiki.gnuradio.org/index.php/FM_Preemphasis" rel="noopener noreferrer" target="_blank">waar je hier meer over kunt lezen</a>, maar die stap is optioneel als je het niet erg vind dat de audio een slechte bas/treble balans heeft. Hieronder zie je de filterresponsie van het IIR filter. Het is meer een vormgevend filter dan een scherp filter.</p>
<a class="reference external image-reference" href="../_images/fm_demph_filter_freq_response.svg" rel="noopener noreferrer" target="_blank"><img alt="../_images/fm_demph_filter_freq_response.svg" class="align-center" src="../_images/fm_demph_filter_freq_response.svg" /></a>
</div>
<div class="section" id="erkenningen">
<h2>Erkenningen<a class="headerlink" href="#erkenningen" title="Permalink to this headline">¶</a></h2>
<p>De meeste RDS-code is overgenomen van het RDS Out-Of-Tree blok voor GNU Radio. Dit heet <a class="reference external" href="https://github.com/bastibl/gr-rds" rel="noopener noreferrer" target="_blank">gr-rds</a>, en is origineel gemaakt door Dimitrios Symeonidis en wordt onderhouden door Bastian Bloessl, dus ik wil deze auteurs de erkenning geven.
Om dit hoofdstuk op te zetten ben ik begonnen met gr-rds in GNU Radio. Met behulp van een werkende FM-opname ben ik langzaam elk blok gaan omzetten naar Python. Dit koste best veel tijd omdat er nuances bij de ingebouwde blokken zitten die makkelijk te missen zijn, en het omzetten van stream-achtige signaalbewerking naar een blok code in Python is zo simpel nog niet. GNU Radio is een geweldige tool voor dit soort prototyping en ik had dit nooit kunnen maken zonder GNU Radio.</p>
</div>
<div class="section" id="extra-leesmateriaal">
<h2>Extra leesmateriaal<a class="headerlink" href="#extra-leesmateriaal" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><a class="reference external" href="https://en.wikipedia.org/wiki/Radio_Data_System" rel="noopener noreferrer" target="_blank">https://en.wikipedia.org/wiki/Radio_Data_System</a></li>
<li><a class="reference external" href="https://www.sigidwiki.com/wiki/Radio_Data_System_(RDS)" rel="noopener noreferrer" target="_blank">https://www.sigidwiki.com/wiki/Radio_Data_System_(RDS)</a></li>
<li><a class="reference external" href="https://github.com/bastibl/gr-rds" rel="noopener noreferrer" target="_blank">https://github.com/bastibl/gr-rds</a></li>
<li><a class="reference external" href="https://www.gnuradio.org/" rel="noopener noreferrer" target="_blank">https://www.gnuradio.org/</a></li>
</ol>
</div>
</div>


          </div>
              <div class="related bottom">
                &nbsp;
  <nav id="rellinks">
    <ul>
    </ul>
  </nav>
              </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2023, Marc Lichtman.
      
    </div>

    

    
  </body>
</html>